## 레디스 메모리 사용량이 조금씩 증가하는 현상
2022년 11월 29일 화요일 (KST) 일부 고객 측 환경으로부터 레디스가 실행중인 서버의 메모리 사용량이 조금씩 증가하는 패턴으로 모니터링되었다는 문의가 전달되었다. 그리고 나서는 레디스의 기본값에 따라 최대 메모리 제한이 없었기 때문에 레디스가 서버 메모리를 대부분 점유하게 되고 레디스가 가상 메모리를 통해 스왑을 시도하게 되면서 레디스와 함께 리눅스 서버의 상태가 이상해지는 상황까지 도달하게 되었다.

#### Caused By
토큰 기반 인증의 OAuth API 에서 RequestContextHolder를 통해 ServletRequestAttributes를 가져온 후 getSessionId()를 호출하게 되는 경우 새로운 세션이 만들어지게 되면서 불필요하게 세션 아이디가 발급될 수 있다. 스프링 세션과 함께 레디스에 세션을 저장하도록 하는 경우 스레드 내에서 새로운 세션이 생성됨에 따라 해당 세션과 관련된 정보들을 레디스에 새로운 키로써 저장하는 동작의 문제가 발생한다. 토큰 기반 인증을 사용하는 요청의 경우에는 세션을 레디스에 저장할 필요가 없기 때문에 빠르게 호출되는 API 라면 불필요하게 레디스에 세션 키가 남아있게 되면서 레디스의 메모리 사용량이 조금씩 증가할 수 있다. 이와 더불어 시스템의 세션 유지 시간을 길게 해야하는 요구사항으로 인하여 세션의 기본 만료 시간이 긴 경우에는 레디스에 불필요하게 저장된 키가 만료되기 까지 상당한 시간이 요구되므로 더 주의해야 한다.

#### Solutions
ServletRequestAttributes의 getSessionId()이 아닌 getRequest()를 통해 직접 세션을 조회 후 세션이 없는 요청이라면 토큰 기반 인증으로 간주하고 세션 아이디가 없다고 처리한다. 따라서, 새로운 세션을 생성하지 않으므로 더이상 레디스에 불필요한 데이터가 적재되지 않는다. 이미 불필요하게 많이 저장된 세션 키들을 삭제하는 것도 큰 부하가 발생하기에 세션 또는 캐시 데이터 이므로 유실되도 상관없다는 판단하에 레디스를 종료한 후 스냅샷으로 저장된 파일을 제거하고 운영적인 측면의 안정성을 위해 최대 메모리 및 메모리 정책을 지정한 뒤 빈 데이터베이스로써 동작하도록 레디스를 다시 실행하였다.
